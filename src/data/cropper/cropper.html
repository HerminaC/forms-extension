<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <link rel='stylesheet' href='cropper.css'/>

</head>
<body>
  <button class='import-button' type='button'>Import</button>
  <div class='main-container' hidden>
  </div>
<script type="text/javascript" charset="utf-8">
(function() {

  // width / height
  var ratio = 4;
  var container = document.querySelector('.main-container');
  var cropperPosition;

  function createInputFile({ accept }) {
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = accept;
  return input;
}

function onEvent(elt, eventName) {
  return new Promise(resolve => {
    elt.addEventListener(eventName, function onEvent() {
      elt.removeEventListener(eventName, onEvent);
      resolve();
    });
  });
}

function onChange(elt) { return onEvent(elt, 'change'); }

function handleImport(file) {
  console.log(file);
  var img = new Image();
  img.src = window.URL.createObjectURL(file);
  img.onload = function() {
    window.URL.revokeObjectURL(img.src);
    startImageCropper(img);
  };
  container.appendChild(img);
  container.hidden = false;
}

function createCropperElement({ top, left, width, height }) {
  var div = document.createElement('div');
  div.className = 'cropper-container';
  div.style.left = left + 'px';
  div.style.top = top + 'px';
  div.style.width = width + 'px';
  div.style.height = height + 'px';

  div.innerHTML = `
    <div class='cropper'>
      <div class='cropper-handle cropper-handle-n'></div>
      <div class='cropper-handle cropper-handle-s'></div>
      <div class='cropper-handle cropper-handle-e'></div>
      <div class='cropper-handle cropper-handle-w'></div>
      <div class='cropper-handle cropper-handle-ne'></div>
      <div class='cropper-handle cropper-handle-se'></div>
      <div class='cropper-handle cropper-handle-nw'></div>
      <div class='cropper-handle cropper-handle-sw'></div>
    </div>
  `;

  cropperPosition = {
    top: 30,
    bottom: 100,
    left: 30,
    right: 310,
  };

  var cropper = div.firstElementChild;
  applyCropperPosition(cropper);
  attachCropperHandlers(cropper);
  return div;
}

function setCropperPosition(positionChange) {
  var oldWidth = cropperPosition.right - cropperPosition.left;
  var oldHeight = cropperPosition.bottom - cropperPosition.top;
  var width = oldWidth + positionChange.right - positionChange.left;
  var height = oldHeight + positionChange.bottom - positionChange.top;
  
  if (oldWidth === width && oldHeight === height) {
    // case of moving without transforming
    cropperPosition = {
      top: cropperPosition.top + positionChange.top,
      bottom: cropperPosition.bottom + positionChange.bottom,
      left: cropperPosition.left + positionChange.left,
      right: cropperPosition.right + positionChange.right
    };
    return;
  }

  if (oldWidth > oldHeight && (positionChange.left || positionChange.right)) {
    height = Math.round(width / ratio);
  } else if (positionChange.bottom || positionChange.top) {
    width = height * ratio;
  } else if (positionChange.left || positionChange.right) {
    height = Math.round(width / ratio);
  }

  var dimensionChanges = {
    width: width - oldWidth,
    height: height - oldHeight
  };

  // TODO This needs fixing:
  if (positionChange.bottom || positionChange.right) {
    positionChange = {
      top: 0,
      left: 0,
      bottom: dimensionChanges.height,
      right: dimensionChanges.width
    };
  } else if (positionChange.left || positionChange.top) {
    positionChange = {
      bottom: 0,
      right: 0,
      top: -dimensionChanges.height,
      left: -dimensionChanges.width
    };
  }

  console.log('positionChange after using ratio', positionChange);

  console.log('old cropperPosition', cropperPosition);
  cropperPosition = {
    top: cropperPosition.top + positionChange.top,
    bottom: cropperPosition.bottom + positionChange.bottom,
    left: cropperPosition.left + positionChange.left,
    right: cropperPosition.right + positionChange.right
  };
  console.log('new cropperPosition', cropperPosition);
}

var existingAnimationRequest;
function applyCropperPosition(cropper) {
  cancelAnimationFrame(existingAnimationRequest);
  existingAnimationRequest = requestAnimationFrame(() => {
    var { top, left, right, bottom } = cropperPosition;
    cropper.style.top = top + 'px';
    cropper.style.left = left + 'px';
    cropper.style.width = (right - left) + 'px';
    cropper.style.height = (bottom - top) + 'px';
  });
}

var currentHandle;
function onCropperHandlerStart(e) {
  currentHandle = e.target;
  currentHandle.setCapture(true);
  currentHandle.addEventListener('mousemove', onCropperHandlerMove);
}

function onCropperHandlerMove(e) {
  var positionChange = {
    top: 0,
    left: 0,
    bottom: 0,
    right: 0
  };

  var classList = e.target.classList;
  if (classList.contains('cropper-handle-n') ||
      classList.contains('cropper-handle-ne') ||
      classList.contains('cropper-handle-nw') ||
      classList.contains('cropper')) {
    positionChange.top = e.movementY;
  }

  if (classList.contains('cropper-handle-s') ||
      classList.contains('cropper-handle-se') ||
      classList.contains('cropper-handle-sw') ||
      classList.contains('cropper')) {
    positionChange.bottom = e.movementY;
  }

  if (classList.contains('cropper-handle-w') ||
      classList.contains('cropper-handle-sw') ||
      classList.contains('cropper-handle-nw') ||
      classList.contains('cropper')) {
    positionChange.left = e.movementX;
  }

  if (classList.contains('cropper-handle-e') ||
      classList.contains('cropper-handle-se') ||
      classList.contains('cropper-handle-ne') ||
      classList.contains('cropper')) {
    positionChange.right = e.movementX;
  }

  console.log('positionChange', positionChange);
  setCropperPosition(positionChange);
  applyCropperPosition(document.querySelector('.cropper'));
}

function onCropperHandlerEnd(e) {
  currentHandle.removeEventListener('mousemove', onCropperHandlerMove);
  currentHandle = null;
}

function attachCropperHandlers(cropper) {
  cropper.addEventListener('mousedown', onCropperHandlerStart);
  cropper.addEventListener('mouseup', onCropperHandlerEnd);
}

function startImageCropper(img) {
  var rect = img.getBoundingClientRect();
  var cropper = createCropperElement(rect);
  document.body.appendChild(cropper);
}

var button = document.querySelector('.import-button');
button.addEventListener('click', () => {
  var input = createInputFile({ accept: 'image/*' });
  onChange(input).then(() => handleImport(input.files[0]));
  input.click();
});

})();
</script>
</body>
</html>
